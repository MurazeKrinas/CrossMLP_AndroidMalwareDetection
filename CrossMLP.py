import tensorflow as tf
from tensorflow import keras
from tensorflow.keras.layers import Dense, Dropout
from tensorflow.keras.activations import elu, sigmoid, softmax
from tensorflow import split

class CrossBlock(keras.layers.Layer):
    def __init__(self, InputDim, DropRatio = 0.2):
        super().__init__()

        # Dropout layer
        self.dropout = Dropout(DropRatio)

        # Initialize dense
        self.Dense_Init = Dense(units=InputDim * 2, activation=elu, input_dim=InputDim)

        # Branch 1
        self.Dense1_Br1 = Dense(units=InputDim * 2, activation=elu, input_dim=InputDim)
        self.Dense2_Br1 = Dense(units=InputDim * 4, activation=elu, input_dim=InputDim * 2)
        
        self.Gate_Br1 = Dense(units=InputDim * 8, activation=elu, input_dim=InputDim * 2)
        self.Fusion_Br1 = Dense(units=InputDim * 6, activation=elu, input_dim=InputDim * 4)

        # Branch 2
        self.Dense1_Br2 = Dense(units=InputDim * 4, activation=elu, input_dim=InputDim)
        self.Dense2_Br2 = Dense(units=InputDim * 8, activation=elu, input_dim=InputDim * 3)
        
        self.Fusion_Br2 = Dense(units=InputDim * 6, activation=elu, input_dim=InputDim * 8)

        # Output 
        self.Output = Dense(units=InputDim, activation=softmax, input_dim=InputDim * 16)

    def call(self, x):
        x = self.Dense_Init(x)
        SplitBranch = split(x, 2, axis=1)
        X_Branch1, X_Branch2 = SplitBranch[0], SplitBranch[1]

        # Branch 1 - Stage 1
        X_Branch1 = self.Dense1_Br1(X_Branch1)
        Identity_Br1 = self.Gate_Br1(X_Branch1)
        X_Branch1 = self.Dense2_Br1(x)
        X_Branch1 = self.dropout(X_Branch1)

        # Branch 2 - Stage 1
        X_Branch2 = self.Dense1_Br2(X_Branch2)
        Identity_Br2 = X_Branch2
        X_Branch2 = self.Dense2_Br2(x)
        X_Branch2 = self.dropout(X_Branch2)


        # Branch 1 - Stage 2
        X_Branch1 *= Identity_Br2
        X_Branch1 = self.Fusion_Br1(X_Branch1)

        # Branch 2 - Stage 2
        X_Branch2 *= Identity_Br1
        X_Branch2 = self.Fusion_Br2(X_Branch2)

        Output = self.dropout(X_Branch1 + X_Branch2)
        Output = self.Output(Output)

        return Output


class CrossMLP(keras.Model):
    def __init__(self, InputDim, NumClass=1, DropRatio=0.3):
        super().__init__()

        # Input
        self.InputDim = InputDim
        self.InitDense = Dense(units=InputDim * 2, activation=elu, input_dim=InputDim)

        # Dropout
        self.dropout = Dropout(DropRatio)

        # CrossBlock
        self.CrossBlock1 = CrossBlock(InputDim)
        self.CrossBlock2 = CrossBlock(InputDim)

        # Ouput
        self.Downgrade1 = Dense(units=InputDim // 2, activation=elu, input_dim=InputDim)
        self.Downgrade2 = Dense(units=InputDim // 4, activation=elu, input_dim=InputDim // 2)
        
        self.Output = Dense(units=NumClass, activation=softmax, input_dim=InputDim // 4)


    def call(self, x):
        x = self.InitDense(x)
        SplitBranch = split(x, 2, axis=1)
        X_Branch1, X_Branch2 = SplitBranch[0], SplitBranch[1]

        X_Branch1 = self.CrossBlock1(X_Branch1)
        Identity1 = X_Branch1
        X_Branch1 = self.CrossBlock1(X_Branch1) + Identity1

        X_Branch2 = self.CrossBlock2(X_Branch2)
        Identity2 = X_Branch2
        X_Branch2 = self.CrossBlock2(X_Branch2) + Identity2

        
        Combined = self.dropout(X_Branch1 + X_Branch2)
        Down1 = self.Downgrade1(Combined)
        Down2 = self.Downgrade2(Down1)
        Output = self.Output(Down2)

        return Output